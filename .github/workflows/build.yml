name: Build and Release Cygwin-based Wheel

on:
  schedule:
    # 每天 UTC 时间凌晨 2 点执行（注意：GitHub 使用的是 UTC 时间）
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip build

      - name: Create cygwin directory
        run: |
          mkdir -p cygwin_pack\cygwin

      - name: Download Cygwin setup
        run: |
          curl -L https://cygwin.com/setup-x86_64.exe -o cygwin_pack\cygwin\cygwin.exe

      - name: Install Cygwin packages silently
        run: |
          cmd /c start /wait .\cygwin_pack\cygwin\cygwin.exe ^
            --quiet-mode ^
            --download ^
            --local-package-dir "%~dp0\cygwin_pack\cygwin" ^
            --site "https://mirrors.kernel.org/sourceware/cygwin/" ^
            --packages "git,make" ^
            --wait
        shell: cmd

      - name: Build wheel
        run: |
          python -m build --wheel --config-setting="--build-option=--plat-name=win_amd64"

      - name: Get current date as tag
        id: date
        run: |
          for /f "tokens=2-4 delims=/ " %%a in ('date /t') do echo TAG=%%c%%a%%b>>%GITHUB_ENV%
        shell: cmd

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: dist/*.whl
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate pip index HTML
        run: |
          python scripts/index.py
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pip_index
          publish_branch: gh-pages
